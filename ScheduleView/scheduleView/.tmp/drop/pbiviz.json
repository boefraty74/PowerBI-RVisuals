{"visual":{"name":"PowerBI-rvisuals-scheduleview","displayName":"ScheduleView","guid":"PBI_CV_658497A5_7E34_4F94_A51F_4E2213BB9051_DEBUG","visualClassName":"Visual","version":"1.0.0","description":"<span>With schedule view you can visualize the start and stop of events. Think of resource planning and systemstates shown in one graphic. <br/><br/><span style='font-style:italic'>Service prerequisites:</span> R-powered custom visual is used in service seamlessly<br/><br /><span style='font-style:italic'>Desktop prerequisites:</span> To run R scripts in Power BI Desktop, you must separately install R on your local computer.<br />You can download and install R for free from the <a href='https://mran.revolutionanalytics.com/download/'>Revolution Open download page</a> or the <a href='https://cran.r-project.org/bin/windows/base/'>CRAN Repository</a><br /><br /> <span style='font-style:italic'> R package dependencies(auto-installed): </span> ggplot2, grid, gridExtra, wesandrson <br /><br /> <span style='font-style:italic'> Supports R versions: </span> R 3.3.1, R 3.3.0, MRO 3.3.1, MRO 3.3.0 <br /></span>","supportUrl":"http://community.powerbi.com/","gitHubUrl":"https://github.com/fathomson/PowerBI-RVisuals/tree/master/ScheduleView/scheduleView"},"apiVersion":"1.3.0","author":{"name":"ICT GROUP","email":"frank.thomson@ict.nl"},"assets":{"icon":"assets/icon.png"},"externalJS":[],"style":"style/visual.less","capabilities":{"dataRoles":[{"displayName":"Resource","kind":"Grouping","name":"Resource"},{"displayName":"User","kind":"Grouping","name":"User"},{"displayName":"Start","kind":"Grouping","name":"Start"},{"displayName":"End","kind":"Grouping","name":"End"}],"dataViewMappings":[{"conditions":[{"Resource":{"max":1},"User":{"max":1},"Start":{"max":1},"End":{"max":1}}],"scriptResult":{"dataInput":{"table":{"rows":{"select":[{"for":{"in":"Resource"}},{"for":{"in":"User"}},{"for":{"in":"Start"}},{"for":{"in":"End"}}],"dataReductionAlgorithm":{"top":{}}}}},"script":{"scriptProviderDefault":"R","scriptOutputType":"png","source":{"objectName":"rcv_script","propertyName":"source"},"provider":{"objectName":"rcv_script","propertyName":"provider"},"scriptSourceDefault":"# Copyright (c) ICT GROUP.  All rights reserved.\r\n\r\n##PBI_R_VISUAL: VIZGAL_SCVIEW  Graphical display of schedule, planning or other events.\r\n# Visualise schedule, planning or events in one graph\r\n#\r\n# INPUT:\r\n# Resource, User, Start, End\r\n#\r\n# CREATION DATE: 12/08/2016\r\n#\r\n# LAST UPDATE: 01/17/2017\r\n#\r\n# VERSION: 1.0.0\r\n#\r\n# R VERSION TESTED: 3.3.2\r\n#\r\n# AUTHOR: F.A. THOMSON (frank.thomson@ict.nl)\r\n\r\n\r\n############### LIBRARY DECLARATIONS ###############\r\n\r\nlibraryRequireInstall = function(packageName, ...)\r\n{\r\n  if (!require(packageName, character.only = TRUE))\r\n    warning(paste(\"*** The package: '\", packageName, \"' was not installed ***\", sep =\r\n                    \"\"))\r\n}\r\n\r\nlibraryRequireInstall(\"ggplot2\")\r\nlibraryRequireInstall(\"grid\")\r\nlibraryRequireInstall(\"gridExtra\")\r\nlibraryRequireInstall(\"wesanderson\")\r\nlibraryRequireInstall(\"RColorBrewer\")\r\nlibraryRequireInstall(\"dplyr\")\r\n\r\n############ INTERNAL FUNCTIONS #########\r\n\r\n# plot error message to user\r\nshowErrorMessageToUser <- function(message) {\r\n  par(mar = c(0, 0, 0, 0))\r\n  plot(\r\n    c(0, 1),\r\n    c(0, 1),\r\n    ann = F,\r\n    bty = 'n',\r\n    type = 'n',\r\n    xaxt = 'n',\r\n    yaxt = 'n'\r\n  )\r\n  text(\r\n    x = 0.5,\r\n    y = 0.5,\r\n    message,\r\n    cex = 1.6,\r\n    col = \"black\"\r\n  )\r\n}\r\n\r\n# check if date in handable format\r\n# TDOD for next version: support multiple date formats\r\ndateInCorrectFormat <- function(date) {\r\n  d <- try(as.Date(date, format = \"%Y-%m-%dT%H:%M:%OS\"))\r\n  if(class(d) == \"try-error\" | is.na(d)){\r\n    d <- try(as.POSIXct(date))\r\n  }\r\n  \r\n  return (class(d) != \"try-error\" & !is.na(d))\r\n}\r\n\r\n\r\n# Get segment size so that they do not overlap on resize / large number of resources.\r\n\r\ngetSegmentSize = function(numCols, numRows, orientation = \"horizontal\", maxW = 25, minW = 1)\r\n{\r\n  convFactor = 20 # unit conversion\r\n  hw = par()$din\r\n  if(orientation == \"horizontal\")\r\n    segSize = hw[2]/numCols\r\n  else\r\n    segSize = 0.5* hw[1]/numRows # take legend into account \r\n  \r\n  segSize = min(max(segSize*convFactor, minW),maxW)\r\n  \r\n  return(segSize)\r\n}\r\n\r\n# Sort the dataset. A-Z (az), Z-A (za), total duration (total_duration) and user count (user_count)\r\n\r\nsortDataset = function(dataset, sorting = \"az\", orientation=\"horizontal\")\r\n{\r\n  switch(sorting,\r\n         \"az\" = {\r\n           if(settings_orientation == \"horizontal\"){\r\n              dataset$Resource  <- factor(dataset$Resource, levels= dataset[rev(order(dataset$Resource)), \"Resource\"])\r\n           } else {\r\n             dataset$Resource  <- factor(dataset$Resource, levels= dataset[order(dataset$Resource), \"Resource\"])\r\n           }\r\n         },\r\n         \"za\" = {\r\n           if(settings_orientation == \"horizontal\"){\r\n             dataset$Resource  <- factor(dataset$Resource, levels= dataset[order(dataset$Resource), \"Resource\"])\r\n           } else {\r\n             dataset$Resource  <- factor(dataset$Resource, levels= dataset[rev(order(dataset$Resource)), \"Resource\"])\r\n           }\r\n        \r\n         },\r\n         \"total_duration\" = {\r\n           dataset$duration <- difftime(dataset$End, dataset$Start, units=\"secs\")\r\n           dataset$duration[is.na(dataset$duration)] <- 0 \r\n           temp <- dataset %>% group_by(Resource) %>% summarize(t=sum(duration)) %>% arrange(t)\r\n           if(settings_orientation == \"horizontal\"){\r\n             dataset$Resource  <- factor(dataset$Resource, levels= temp$Resource)\r\n           } else {\r\n             dataset$Resource  <- factor(dataset$Resource, levels= rev(temp$Resource))\r\n           }\r\n         },\r\n         \"user_count\" = {\r\n           temp <- dataset %>% group_by(Resource) %>% summarize(n=n()) %>% arrange(n)\r\n           if(settings_orientation == \"horizontal\"){\r\n             dataset$Resource  <- factor(dataset$Resource, levels= temp$Resource)\r\n           } else {\r\n             dataset$Resource  <- factor(dataset$Resource, levels= rev(temp$Resource))\r\n           }\r\n         })\r\n  return(dataset)\r\n}\r\n\r\n# strText = text to modify \r\n# strCex = font size \r\n# abbrTo = very long string will be abbreviated to \"abbrTo\" characters\r\n# isH = \"is horizontal\" ?\r\n# maxChar = text smaller than maxChar is replaced by NULL\r\n# partAvailable = which portion of window is available for text, in [0,1]\r\n\r\ncutStr2Show = function(strText, strCex = 0.8, abbrTo = 100, isH = TRUE, maxChar = 0, partAvailable = 1)\r\n{\r\n\r\n  if(is.null(strText))\r\n    return (NULL)\r\n  \r\n  SCL = 0.094*strCex\r\n  pardin = par()$din\r\n  gStand = partAvailable*(isH*pardin[1]+(1-isH)*pardin[2]) /SCL\r\n  \r\n  # if very very long abbreviate\r\n  if(nchar(strText)>abbrTo && nchar(strText)> 1)\r\n    strText = abbreviate(strText, abbrTo, dot = TRUE)\r\n  \r\n  # if looooooong convert to lo...\r\n  if(nchar(strText)>round(gStand) && nchar(strText)> 1)\r\n    strText = paste(substring(strText,1,floor(gStand)),\"...\",sep=\"\")\r\n  \r\n  # if shorter than maxChar remove \r\n  if(gStand<=maxChar)\r\n    strText = NULL\r\n  \r\n  return(strText) \r\n}\r\n\r\n\r\n# Calculate and return the number of legend columns as selected by the user\r\n\r\ngetNcolLegend = function(ncols = \"auto\"){\r\n  colCount <- 1;\r\n  switch(ncols,\r\n        \"auto\" = { colCount <- ceiling(nrow(unique(User))/nrow(unique(Resource)))},\r\n        \"one\" = {colCount <- 1},\r\n        \"two\" = {colCount <- 2},\r\n        \"three\" = {colCount <- 3},\r\n        \"four\" = {colCount <- 4},\r\n        \"five\" = {colCount <- 5})\r\n  return(colCount)\r\n}\r\n  \r\n\r\n\r\n\r\n############ INPUT / DATE VALIDATION #########\r\n\r\ninput_valid <- TRUE\r\ndates_valid <- TRUE\r\nmessage <- \"\"\r\n\r\nif (!exists(\"Resource\")) {\r\n  input_valid <- FALSE\r\n  message <- paste(message, \"Resource \")\r\n}\r\nif (!exists(\"User\")) {\r\n  input_valid <- FALSE\r\n  message <- paste(message, \"User \")\r\n}\r\nif (!exists(\"Start\")) {\r\n  input_valid <- FALSE\r\n  message <- paste(message, \"Start \")\r\n}\r\nif (!exists(\"End\")) {\r\n  input_valid <- FALSE\r\n  message <- paste(message, \"End \" + settings_orientation)\r\n}\r\n\r\n\r\n\r\n\r\n\r\nif (input_valid) {\r\n  # Assign columns to dataset\r\n  dataset <- cbind(Resource, User, Start, End)\r\n  # Rename columns\r\n  colnames(dataset) <- c(\"Resource\", \"User\", \"Start\", \"End\")\r\n  # Remvoe NA's\r\n  dataset <- na.omit(dataset)\r\n  dates_valid <-   (dateInCorrectFormat(dataset$Start[1]) &\r\n                      dateInCorrectFormat(dataset$End[1]))\r\n} else {\r\n  dates_valid <- FALSE\r\n  plot.new()\r\n  #showErrorMessageToUser(paste(\"All four fields required, please add: \", message))\r\n}\r\n\r\n\r\n\r\n############ INPUT / DATE VALIDATION #########\r\nif(input_valid){\r\n\r\nif (dates_valid) {\r\n  if(!exists(\"settings_sorting\"))\r\n  {\r\n    settings_sorting = \"az\";\r\n  }\r\n  \r\n  if (!exists(\"settings_colorPalette\"))\r\n  {\r\n    settings_colorPalette = \"Set1\";\r\n  }\r\n  \r\n  if (!exists(\"settings_orientation\"))\r\n  {\r\n    settings_orientation= \"horizontal\";\r\n  }\r\n  if(!exists(\"settings_legendCols\")){\r\n    settings_legendCols = \"auto\";\r\n  }\r\n  \r\n  dataset$Start <-\r\n    as.POSIXct(dataset$Start, format = \"%Y-%m-%dT%H:%M:%OS\")\r\n  dataset$End <-\r\n    as.POSIXct(dataset$End,  format = \"%Y-%m-%dT%H:%M:%OS\")\r\n  \r\n  colourCount <- length(unique(dataset$User))\r\n  getPalette <- colorRampPalette(brewer.pal(8, settings_colorPalette))\r\n  \r\n  segSize = getSegmentSize(length(unique(dataset$Resource)), length(unique(dataset$User)), orientation = settings_orientation)\r\n  \r\n  dataset <- sortDataset(dataset, sorting = settings_sorting, orientation = settings_orientation)\r\n  \r\n  dataset$User <- abbreviate(dataset$User, 30)\r\n  \r\n  ncolLegend <- getNcolLegend(ncols = settings_legendCols);\r\n\r\n  if(settings_orientation == \"horizontal\"){\r\n    ggplot(dataset, aes(x = Start, y = Resource, color = User)) +\r\n      geom_segment(aes(x = Start, xend = End, y = Resource,yend = Resource), size = segSize) +\r\n      xlab(\"Time\") +\r\n      ylab(cutStr2Show(names(Resource), abbrTo = 50)) +\r\n      labs(color=names(User))+\r\n      theme_bw()  +\r\n      scale_colour_manual(values = getPalette(colourCount)) + \r\n      theme(legend.direction =\"vertical\",legend.position = \"right\") + guides(color=guide_legend(ncol=ncolLegend))\r\n\r\n  } else {\r\n    ggplot(dataset, aes(x = Resource, y = Start, color = User)) +\r\n      geom_segment(aes(x = Resource, xend = Resource, y = Start,yend = End), size = segSize) +\r\n      ylab(\"Time\") +\r\n      xlab(cutStr2Show(names(Resource), abbrTo = 50)) +\r\n      labs(color=names(User))+\r\n      theme_bw() + \r\n      scale_colour_manual(values = getPalette(colourCount)) +\r\n      theme(axis.text.x = element_text(angle = 45, hjust = 1))+ guides(color=guide_legend(ncol=ncolLegend))\r\n  }\r\n  \r\n  \r\n} else {\r\n  showErrorMessageToUser(\r\n    paste0(\"Unable to parse dates\\n\r\n      dates recieved: Start[1]= \", Start[1], \"   End[1]=\", End[1]\r\n    )\r\n    )\r\n}\r\n}\r\n  \r\n"}}}],"objects":{"rcv_script":{"properties":{"provider":{"type":{"text":true}},"source":{"type":{"scripting":{"source":true}}}}},"settings":{"displayName":"Settings","description":"Schedule view settings","properties":{"sorting":{"displayName":"Sort","description":"Resource sorting","type":{"enumeration":[{"displayName":"Alphabetical A-Z","value":"az"},{"displayName":"Alphabetical Z-A","value":"za"},{"displayName":"By total duration","value":"total_duration"},{"displayName":"By user count","value":"user_count"}]}},"orientation":{"displayName":"Orientation","description":"Visual orientation","type":{"enumeration":[{"displayName":"Horizontal","value":"horizontal"},{"displayName":"Vertical","value":"vertical"}]}},"colorPalette":{"displayName":"Color palette","description":"Select brewer color palette","type":{"enumeration":[{"displayName":"Spring","value":"Accent"},{"displayName":"Vintage","value":"Dark2"},{"displayName":"Green and blue","value":"Paired"},{"displayName":"Vintage light","value":"Pastel1"},{"displayName":"Modern light","value":"Pastel2"},{"displayName":"Retro light","value":"Set1"},{"displayName":"Retro","value":"Set2"},{"displayName":"Modern","value":"Set3"}]}},"legendCols":{"displayName":"Legend columns","description":"# of legend columns","type":{"enumeration":[{"displayName":"auto","value":"auto"},{"displayName":"1","value":"one"},{"displayName":"2","value":"two"},{"displayName":"3","value":"three"},{"displayName":"4","value":"four"},{"displayName":"5","value":"five"}]}}}}},"suppressDefaultTitle":true},"dependencies":{"cranPackages":[{"name":"ggplot2","displayName":"GG Plot 2","url":"https://cran.r-project.org/web/packages/ggplot2/index.html"},{"name":"grid","displayName":"Grid","url":"https://cran.r-project.org/web/packages/grid/index.html"},{"name":"gridExtra","displayName":"Grid Extra","url":"https://cran.r-project.org/web/packages/gridExtra/index.html"},{"name":"wesanderson","displayName":"A Wes Anderson Palette Generator","url":"https://cran.r-project.org/web/packages/wesanderson/index.html"},{"name":"dplyr","displayName":"A fast, consistent tool for working with data frame like objects, both in memory and out of memory.","url":"https://cran.r-project.org/web/packages/dplyr/index.html"}]},"content":{"js":"var powerbi;!function(t){var e;!function(t){var e;!function(t){var e;!function(t){function e(t,e,i,n){if(t){var a=t[e];if(a){var s=a[i];if(void 0!==s)return s}}return n}function i(t,e,i,n){if(t){var a=t[e];if(a){var s=a[i];if(void 0!==s&&void 0!==s.solid&&void 0!==s.solid.color)return s.solid.color}}return n}t.getValue=e,t.getFillValue=i}(e=t.PBI_CV_658497A5_7E34_4F94_A51F_4E2213BB9051||(t.PBI_CV_658497A5_7E34_4F94_A51F_4E2213BB9051={}))}(e=t.visual||(t.visual={}))}(e=t.extensibility||(t.extensibility={}))}(powerbi||(powerbi={}));var powerbi;!function(t){var e;!function(t){var e;!function(t){var e;!function(t){var e=function(){function e(t){this.imageDiv=document.createElement(\"div\"),this.imageDiv.className=\"rcv_autoScaleImageContainer\",t.element.appendChild(this.imageDiv),this.imageElement=document.createElement(\"img\"),this.imageElement.className=\"rcv_autoScaleImage\",this.imageDiv.appendChild(this.imageElement),this.settings={sorting:\"az\",orientation:\"horizontal\",colorPalette:\"Set1\",legendCols:\"auto\"}}return e.prototype.update=function(e){var i=e.dataViews;if(i&&0!==i.length){var n=i[0];if(n&&n.metadata){this.settings={sorting:t.getValue(n.metadata.objects,\"settings\",\"sorting\",\"az\"),orientation:t.getValue(n.metadata.objects,\"settings\",\"orientation\",\"horizontal\"),colorPalette:t.getValue(n.metadata.objects,\"settings\",\"colorPalette\",\"Set1\"),legendCols:t.getValue(n.metadata.objects,\"settings\",\"legendCols\",\"auto\")};var a=null;n.scriptResult&&n.scriptResult.payloadBase64&&(a=\"data:image/png;base64,\"+n.scriptResult.payloadBase64),a?this.imageElement.src=a:this.imageElement.src=null,this.onResizing(e.viewport)}}},e.prototype.onResizing=function(t){this.imageDiv.style.height=t.height+\"px\",this.imageDiv.style.width=t.width+\"px\"},e.prototype.updateObjects=function(e){this.settings={sorting:t.getValue(e,\"settings\",\"sorting\",\"az\"),orientation:t.getValue(e,\"settings\",\"orientation\",\"horizontal\"),colorPalette:t.getValue(e,\"settings\",\"colorPalette\",\"Set1\"),legendCols:t.getValue(e,\"settings\",\"legendCols\",\"auto\")}},e.prototype.enumerateObjectInstances=function(t){var e=t.objectName,i=[];switch(e){case\"settings\":i.push({objectName:e,properties:{sorting:this.settings.sorting,orientation:this.settings.orientation,colorPalette:this.settings.colorPalette,legendCols:this.settings.legendCols},selector:null})}return i},e}();t.Visual=e}(e=t.PBI_CV_658497A5_7E34_4F94_A51F_4E2213BB9051||(t.PBI_CV_658497A5_7E34_4F94_A51F_4E2213BB9051={}))}(e=t.visual||(t.visual={}))}(e=t.extensibility||(t.extensibility={}))}(powerbi||(powerbi={}));var powerbi;!function(t){var e;!function(e){var i;!function(e){e.PBI_CV_658497A5_7E34_4F94_A51F_4E2213BB9051={name:\"PBI_CV_658497A5_7E34_4F94_A51F_4E2213BB9051\",displayName:\"ScheduleView\",class:\"Visual\",version:\"1.0.0\",apiVersion:\"1.3.0\",create:function(e){return new t.extensibility.visual.PBI_CV_658497A5_7E34_4F94_A51F_4E2213BB9051.Visual(e)},custom:!0}}(i=e.plugins||(e.plugins={}))}(e=t.visuals||(t.visuals={}))}(powerbi||(powerbi={}));","css":".visual-PBI_CV_658497A5_7E34_4F94_A51F_4E2213BB9051 .rcv_autoScaleImageContainer{position:relative}.visual-PBI_CV_658497A5_7E34_4F94_A51F_4E2213BB9051 .rcv_autoScaleImageContainer .rcv_autoScaleImage{max-width:100%;max-height:100%;position:absolute;top:50%;left:50%;transform:translateY(-50%) translateX(-50%);-webkit-transform:translateY(-50%) translateX(-50%)}","iconBase64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUAgMAAADw5/WeAAAACVBMVEUAAAAAl7FhYWA9yqGWAAAAAXRSTlMAQObYZgAAACJJREFUCNdjgADR0FCvFThJCNBa1Rgagp+EqVwI1IWTBAMA4+kexFglxAgAAAAASUVORK5CYII="}}